class CastbookController < ApplicationController
  def index
    #if params[:id]
    #  page = params[:id]
    #else
    #  page = 1
    #end
    #gender = params[:gender]

    page = page.to_i - 1
    page_size = 16
    offset = (page * page_size)
#TODO Add filtering system to castbook

    #@castbook = Person #.where('gender LIKE ?', params[:gender])
    #  .order(:date_of_birth)
    #  .limit(page_size)
    #  .offset(offset)

    #@castbook = Person.active.limit(page_size).offset(offset)

    @nav = (Person.count.to_f / page_size).ceil

# data for gender checkboxes
    f = Hash.new(0)
    Person.active.count(group: :gender).each{|k, v| f.store(k,"#{k} (#{v})")}
    @gender_group = f.sort.reverse

# data for age checkboxes
    h = Hash.new(0)
    f = Hash.new(0)
    Person.active.each {|v| h.store(v.age_group_id, h[v.age_group_id]+1) }
    (Person.age_groups.map {|p| [p[:id], p[:text]] }).each{|k, v| f.store(k, "#{v} (#{h[k]})") }
    @age_group = f

# data for height checkboxes
    h = Hash.new(0)
    f = Hash.new(0)
    Person.active.each {|v| h.store(v.height_group_id, h[v.height_group_id]+1) }
    (Person.height_groups.map {|p| [p[:id], p[:text]] }).each{|k, v| f.store(k, "#{v} (#{h[k]})") }
    @height_group = f

# data for hair colour checkboxes
    h = Hash.new(0)
    f = Hash.new(0)
    Person.active.each {|v| h.store(v.height_group_id, h[v.height_group_id]+1) }
    (Person.height_groups.map {|p| [p[:id], p[:text]] }).each{|k, v| f.store(k, "#{v} (#{h[k]})") }
    @hair_group = f

    respond_to do |format|
      format.html # index.html.erb
      format.json {
        render json:
         @castbook.as_json(
            only: [:id, :gender],
            methods: [:full_name, :height_group, :thumbnail_url])
      }
      format.xml {
        render xml: @castbook.sample(25).to_xml(
            only: [:id],
            methods: [:url, :thumbnail_url])
      }
    end
  end

  def castlist
    cons = ['status = ?', 'Active']

# Add gender parameters
    if(params[:gender])
      cons[0] += ' AND gender IN(?)'
      cons << params[:gender]
    end

# Add age parameters
    if(params[:age])
      s = []
      ag = Person.age_groups
      params[:age].each do |i|
        s << '( date_of_birth BETWEEN ? AND ? )'
        cons << ag[i.to_i][:from]
        cons << ag[i.to_i][:to]
      end
      cons[0] += " AND (#{s.join(' OR ')})"
    end

# Add height parameters
    if(params[:height])
      s = []
      ag = Person.height_groups
      params[:height].each do |i|
        s << '( (height_feet * 12) + height_inches BETWEEN ? AND ? )'
        cons << ag[i.to_i][:from]
        cons << ag[i.to_i][:to]
      end
      cons[0] += " AND (#{s.join(' OR ')})"
    end

    #cons.each {|e| puts "--> #{e}"}
    @castbook = Person.where(cons).limit(16).active
    render partial: 'castlist'
  end

  def show
    if Person.exists?(params[:id])
      cast = Person.find(params[:id])

      @castbook = cast
      @skill = (Skill.where(person_id: @castbook.id)).collect {|s| s.skill_text}.join(', ')
      @credit = Credit.where(person_id: @castbook.id).order(:display_order)

      cast = Person.find(params[:id])
      cast.view_count += 1 if (Time.now.utc.to_date - cast.last_viewed_at.to_date).to_i > 1
      cast.last_viewed_at = Time.now.utc
      cast.save
    else
      redirect_to controller: 'castbook'
    end

  end

  def random
    @castbook = Person.all
    respond_to do |format|
      format.xml {
        render xml: @castbook.sample(25).to_xml(
            only: [:id],
            methods: [:url, :carousel_url])
      }
    end
  end
end
